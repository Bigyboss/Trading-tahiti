<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tahiti Trading Terminal</title>
    <style>
        :root {
            --bg: #0b0e11;
            --card: #1e2329;
            --card2: #252b35;
            --green: #02c076;
            --red: #f84960;
            --yellow: #f0b90b;
            --text: #eaecef;
            --gray: #848e9c;
            --blue: #3498db;
            --purple: #9b59b6;
            --orange: #e67e22;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1100px; }

        /* HEADER */
        .header {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            margin-bottom: 15px; background: var(--card); padding: 15px;
            border-radius: 12px; border-bottom: 4px solid var(--yellow); gap: 10px;
        }
        .clock-section { flex: 1; min-width: 200px; }
        .clock { font-size: clamp(1.8rem, 5vw, 2.2rem); font-weight: bold; font-family: monospace; color: var(--yellow); }
        .utc-clock { font-size: 0.85rem; font-family: monospace; color: var(--gray); margin-top: 2px; }

        /* SEASON SWITCH */
        .season-switch { background: #2b3139; padding: 5px; border-radius: 8px; display: flex; gap: 5px; align-items: center; }
        .btn-season {
            padding: 8px 14px; border: none; border-radius: 5px; cursor: pointer;
            background: transparent; color: var(--gray); font-weight: bold; font-size: 0.8rem; transition: all 0.2s;
        }
        .btn-season.active { background: var(--yellow); color: black; }

        /* SECTION TITLE */
        .section-title { margin: 20px 0 10px 5px; font-weight: bold; color: var(--yellow); font-size: 0.9rem; display: flex; align-items: center; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: #333; margin-left: 10px; }

        /* REGION TABS */
        .region-tabs { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .region-tab {
            padding: 5px 12px; border-radius: 20px; border: 1px solid #333; cursor: pointer;
            font-size: 0.75rem; font-weight: bold; background: var(--card2); color: var(--gray);
            transition: all 0.2s;
        }
        .region-tab.active { border-color: var(--yellow); color: var(--yellow); background: rgba(240,185,11,0.1); }
        .region-tab.fav-tab { border-color: var(--orange); color: var(--orange); }
        .region-tab.fav-tab.active { background: rgba(230,126,34,0.15); }

        /* MARKET TABLE */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; min-width: 300px; }
        th { text-align: left; padding: 8px 10px; color: var(--gray); font-size: 0.72rem; text-transform: uppercase; }
        tr.market-row { background: var(--card); transition: background 0.3s; }
        tr.market-row:hover { background: var(--card2); }
        td { padding: 10px 10px; border: none; font-size: 0.85rem; }
        td:first-child { border-radius: 8px 0 0 8px; }
        td:last-child { border-radius: 0 8px 8px 0; }

        /* BREAK indicator */
        .break-badge { font-size: 0.62rem; color: var(--orange); border: 1px solid var(--orange); padding: 2px 5px; border-radius: 3px; margin-left: 5px; }

        /* PROGRESS BAR */
        .progress-wrap { height: 3px; background: #333; border-radius: 2px; width: 100%; min-width: 80px; }
        .progress-bar { height: 3px; border-radius: 2px; transition: width 0.5s; }
        .bar-open { background: var(--green); }
        .bar-break { background: var(--orange); }
        .bar-closed { background: #333; }

        /* STATUS */
        .status-badge { padding: 3px 7px; border-radius: 4px; font-size: 0.68rem; font-weight: bold; white-space: nowrap; }
        .open { color: var(--green); border: 1px solid var(--green); }
        .on-break { color: var(--orange); border: 1px solid var(--orange); }
        .closed { color: var(--gray); border: 1px solid #444; opacity: 0.7; }
        .region-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; flex-shrink: 0; }

        /* COUNTDOWN */
        .countdown { font-size: 0.68rem; color: var(--gray); font-family: monospace; margin-top: 2px; }
        .countdown.soon { color: var(--yellow); }

        /* OVERLAP HEATMAP */
        .heatmap-scroll { overflow-x: auto; margin-bottom: 10px; }
        .heatmap-table { min-width: 650px; width: 100%; border-collapse: collapse; }
        .heatmap-table th { font-size: 0.62rem; color: var(--gray); padding: 3px 1px; text-align: center; border: none; }
        .heatmap-table td { width: 3.8%; height: 28px; border: 1px solid #0b0e11; transition: all 0.3s; font-size: 0.52rem; text-align: center; vertical-align: middle; color: transparent; cursor: default; }
        .heatmap-table td:hover { opacity: 0.8; color: white; }
        .heatmap-table .mkt-label { width: 105px; font-size: 0.7rem; color: var(--text); text-align: right; padding-right: 8px; white-space: nowrap; background: transparent; border: none; height: auto; }
        .heatmap-table .hour-now { outline: 2px solid var(--yellow); outline-offset: -2px; border-radius: 1px; }
        .heat-0 { background: #161b22; }
        .heat-1 { background: rgba(52,152,219,0.2); }
        .heat-2 { background: rgba(52,152,219,0.45); }
        .heat-3 { background: rgba(52,152,219,0.7); }
        .heat-4 { background: rgba(2,192,118,0.75); }
        .heat-5 { background: rgba(2,192,118,0.95); }
        .heat-open { background: rgba(52,152,219,0.5); }
        .heat-break { background: rgba(230,126,34,0.3); }
        .overlap-legend { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; color: var(--gray); }
        .legend-box { width: 13px; height: 13px; border-radius: 2px; }

        /* OVERLAP CARDS */
        .overlap-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(195px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .overlap-card { background: var(--card); padding: 12px; border-radius: 8px; border-left: 3px solid var(--blue); }
        .overlap-card.live { border-left-color: var(--green); background: rgba(2,192,118,0.07); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(2,192,118,0.3)} 50%{box-shadow:0 0 8px 2px rgba(2,192,118,0.15)} }
        .overlap-title { font-weight: bold; font-size: 0.82rem; }
        .overlap-time { font-family: monospace; color: var(--yellow); font-size: 0.9rem; }
        .overlap-desc { color: var(--gray); font-size: 0.7rem; margin-top: 3px; }

        /* ALGOS */
        .algo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-bottom: 30px; }
        .algo-card { background: var(--card); padding: 12px; border-radius: 8px; border-left: 3px solid #2b3a50; transition: all 0.3s; }
        .algo-active { border-left: 5px solid var(--green); background: rgba(2,192,118,0.1); }
        .algo-next { border-left-color: var(--yellow); }
        .algo-time { font-family: monospace; color: var(--yellow); font-size: 0.9rem; }
        .algo-title { font-size: 0.8rem; color: var(--text); margin-top: 2px; }

        /* CALENDAR */
        .calendar-wrapper { border-radius: 12px; overflow: hidden; height: 500px; background: var(--card); border: 1px solid #333; margin-bottom: 20px; }

        /* NOTE BOX */
        .note-box { background: rgba(240,185,11,0.07); border: 1px solid rgba(240,185,11,0.2); border-radius: 8px; padding: 10px 14px; margin-bottom: 12px; font-size: 0.75rem; color: var(--gray); }

        @media (max-width: 480px) {
            .header { justify-content: center; text-align: center; }
            .season-switch { width: 100%; justify-content: center; }
            td { padding: 8px 5px; font-size: 0.78rem; }
            .clock { font-size: 1.8rem; }
            .heatmap-table .mkt-label { width: 75px; font-size: 0.62rem; }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- HEADER -->
    <div class="header">
        <div class="clock-section">
            <div style="color: var(--gray); font-size: 0.8rem;">ğŸŒº TAHITI LOCAL TIME (UTCâˆ’10)</div>
            <div class="clock" id="clock">00:00:00</div>
            <div id="date" style="font-size: 0.8rem; color: var(--text);">--</div>
            <div class="utc-clock" id="utc-clock">UTC --:--</div>
        </div>
        <div class="season-switch">
            <button class="btn-season" id="btn-hiver" onclick="setSeason('hiver')">â„ï¸ WINTER</button>
            <button class="btn-season" id="btn-ete" onclick="setSeason('ete')">â˜€ï¸ SUMMER</button>
        </div>
    </div>

    <!-- MARKETS -->
    <div class="section-title">ğŸŒ MarchÃ©s Mondiaux</div>
    <div class="note-box">â° Horaires en heure locale Tahiti (UTCâˆ’10). Les pauses dÃ©jeuner sont indiquÃ©es en ğŸ±. Heures vÃ©rifiÃ©es sur sources officielles.</div>
    <div class="region-tabs" id="region-tabs">
        <div class="region-tab fav-tab active" onclick="setRegion('fav')">â­ Principales</div>
        <div class="region-tab" onclick="setRegion('all')">ğŸŒ Toutes</div>
        <div class="region-tab" onclick="setRegion('americas')">ğŸŒ AmÃ©riques</div>
        <div class="region-tab" onclick="setRegion('europe')">ğŸŒ Europe</div>
        <div class="region-tab" onclick="setRegion('asia')">ğŸŒ Asie-Pac.</div>
        <div class="region-tab" onclick="setRegion('mideast')">ğŸ•Œ M-Orient/Afrique</div>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>MarchÃ©</th>
                    <th>Horaires Tahiti <span style="font-size:0.6rem;color:#555">(UTCâˆ’10)</span></th>
                    <th>Session</th>
                    <th style="text-align: right;">Statut</th>
                </tr>
            </thead>
            <tbody id="market-list"></tbody>
        </table>
    </div>

    <!-- OVERLAP -->
    <div class="section-title">ğŸ”¥ Chevauchement des Sessions</div>
    <div class="overlap-legend">
        <div class="legend-item"><div class="legend-box heat-0" style="border:1px solid #333"></div>FermÃ©</div>
        <div class="legend-item"><div class="legend-box heat-1"></div>1â€“2 marchÃ©s</div>
        <div class="legend-item"><div class="legend-box heat-2"></div>3â€“4</div>
        <div class="legend-item"><div class="legend-box heat-3"></div>5â€“7</div>
        <div class="legend-item"><div class="legend-box heat-4"></div>8â€“10</div>
        <div class="legend-item"><div class="legend-box heat-5"></div>11+ (pic)</div>
        <div class="legend-item"><div class="legend-box heat-break"></div>Pause dÃ©j.</div>
    </div>
    <div class="heatmap-scroll">
        <table class="heatmap-table" id="heatmap"></table>
    </div>
    <div class="overlap-cards" id="overlap-cards"></div>

    <!-- ALGOS -->
    <div class="section-title">ğŸ¤– Activation Algos</div>
    <div class="algo-grid" id="algo-list"></div>

    <!-- CALENDAR -->
    <div class="section-title">ğŸ“… Calendrier Ã‰conomique</div>
    <div class="calendar-wrapper">
        <div class="tradingview-widget-container" style="height: 100%;">
            <div class="tradingview-widget-container__widget"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
            { "colorTheme": "dark", "isMaximized": true, "width": "100%", "height": "100%", "locale": "fr", "importanceFilter": "0,1", "countryFilter": "us,eu,gb,jp,au,ca,cn,ch,de,fr" }
            </script>
        </div>
    </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKET DATA â€” all times in Tahiti local (UTCâˆ’10)
// Verified against official exchange sources
// 
// UTC offset reference:
//   New York EST   = UTCâˆ’5  â†’ Tahiti = local+5h  (hiver NYSE 14:30 UTC = 04:30 Tahiti)
//   New York EDT   = UTCâˆ’4  â†’ Tahiti = local+6h  (Ã©tÃ©   NYSE 13:30 UTC = 03:30 Tahiti)
//   London GMT     = UTC+0  â†’ Tahiti = localâˆ’10h (hiver LSE  08:00 UTC = 22:00 Tahiti)
//   London BST     = UTC+1  â†’ Tahiti = localâˆ’11h (Ã©tÃ©   LSE  07:00 UTC = 21:00 Tahiti)
//   Paris  CET     = UTC+1  â†’ hiver Euronext 08:00 UTC = 22:00 Tahiti
//   Paris  CEST    = UTC+2  â†’ Ã©tÃ©   Euronext 07:00 UTC = 21:00 Tahiti
//   Tokyo  JST     = UTC+9  â†’ fixed  TSE 00:00 UTC = 14:00 Tahiti (prev day)
//   HK     HKT     = UTC+8  â†’ fixed  HKEX 01:30 UTC = 15:30 Tahiti (prev day)
//   Sydney AEDT    = UTC+11 â†’ hiver ASX  23:00 UTC prev = 13:00 Tahiti
//   Sydney AEST    = UTC+10 â†’ Ã©tÃ©   ASX  00:00 UTC = 14:00 Tahiti
//   Riyadh AST     = UTC+3  â†’ no DST, Tadawul 07:00 UTC = 21:00 Tahiti (prev day)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const REGION_COLORS = { americas:'#3498db', europe:'#9b59b6', asia:'#02c076', mideast:'#e67e22' };

// sessions: array of {open, close} â€” supports lunch breaks
// fav: true = shown in "Principales" tab
const ALL_MARKETS = [
    // â”€â”€ AMÃ‰RIQUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'nq_es',   name:'NQ/ES FUTURES (CME)',  region:'americas', fav:true,
      hiver:[{open:'13:00',close:'12:00'}],
      ete: [{open:'12:00',close:'11:00'}] },

    { id:'nyse',    name:'NYSE / NASDAQ',         region:'americas', fav:true,
      hiver:[{open:'04:30',close:'11:00'}],
      ete: [{open:'03:30',close:'10:00'}] },

    { id:'tsx',     name:'TSX TORONTO',           region:'americas', fav:false,
      hiver:[{open:'04:30',close:'11:00'}],
      ete: [{open:'03:30',close:'10:00'}] },

    { id:'bmv',     name:'BMV MEXICO',            region:'americas', fav:false,
      hiver:[{open:'05:30',close:'12:00'}],
      ete: [{open:'04:30',close:'11:00'}] },

    { id:'bovespa', name:'BOVESPA BRÃ‰SIL (B3)',  region:'americas', fav:false,
      // B3 = UTCâˆ’3, opens 10:00 local (13:00 UTC hiver = 03:00 Tahiti)
      hiver:[{open:'03:00',close:'10:00'}],
      ete: [{open:'03:00',close:'10:00'}] },

    { id:'bcs',     name:'BCS SANTIAGO',          region:'americas', fav:false,
      hiver:[{open:'04:00',close:'12:00'}],
      ete: [{open:'03:00',close:'11:00'}] },

    // â”€â”€ EUROPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'lse',     name:'LSE LONDON',            region:'europe', fav:true,
      // 08:00â€“16:30 UTC hiver / 07:00â€“15:30 UTC Ã©tÃ© â†’ Tahiti
      hiver:[{open:'22:00',close:'06:30'}],
      ete: [{open:'21:00',close:'05:30'}] },

    { id:'euronext',name:'EURONEXT PARIS/AMS',    region:'europe', fav:true,
      // 09:00â€“17:30 CET hiver (= 08:00â€“16:30 UTC) / CEST Ã©tÃ© (= 07:00â€“15:30 UTC)
      hiver:[{open:'22:00',close:'06:30'}],
      ete: [{open:'21:00',close:'05:30'}] },

    { id:'xetra',   name:'XETRA FRANCFORT',       region:'europe', fav:true,
      // 09:00â€“17:30 CET = same as Euronext
      hiver:[{open:'22:00',close:'06:30'}],
      ete: [{open:'21:00',close:'05:30'}] },

    { id:'mib',     name:'MIB MILAN (Euronext)',  region:'europe', fav:false,
      hiver:[{open:'22:00',close:'06:30'}],
      ete: [{open:'21:00',close:'05:30'}] },

    { id:'ibex',    name:'IBEX MADRID (BME)',      region:'europe', fav:false,
      hiver:[{open:'22:00',close:'06:30'}],
      ete: [{open:'21:00',close:'05:30'}] },

    { id:'smi',     name:'SMI ZURICH (SIX)',       region:'europe', fav:false,
      hiver:[{open:'22:00',close:'06:30'}],
      ete: [{open:'21:00',close:'05:30'}] },

    { id:'omx',     name:'OMX STOCKHOLM (Nasdaq)', region:'europe', fav:false,
      hiver:[{open:'22:00',close:'06:30'}],
      ete: [{open:'21:00',close:'05:30'}] },

    { id:'moex',    name:'MOEX MOSCOU',            region:'europe', fav:false,
      // 09:50â€“18:50 MSK (UTC+3) â†’ hiver 06:50â€“15:50 UTC â†’ Tahiti 20:50â€“05:50
      both:[{open:'20:50',close:'05:50'}] },

    // â”€â”€ ASIE-PACIFIQUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'asx',     name:'ASX SYDNEY',             region:'asia', fav:true,
      // AEDT(UTC+11) hiver: 10:00â€“16:00 local = 23:00â€“05:00 UTC = 13:00â€“19:00 Tahiti
      // AEST(UTC+10) Ã©tÃ©:  10:00â€“16:00 local = 00:00â€“06:00 UTC = 14:00â€“20:00 Tahiti
      hiver:[{open:'13:00',close:'19:00'}],
      ete: [{open:'14:00',close:'20:00'}] },

    { id:'nzx',     name:'NZX WELLINGTON',         region:'asia', fav:false,
      // NZDT(UTC+13) hiver: 10:00â€“17:45 local = 21:00â€“04:45 UTC prev = 11:00â€“18:45 Tahiti
      // NZST(UTC+12) Ã©tÃ©:   10:00â€“17:45 local = 22:00â€“05:45 UTC = 12:00â€“19:45 Tahiti
      hiver:[{open:'11:00',close:'18:45'}],
      ete: [{open:'12:00',close:'19:45'}] },

    { id:'tse',     name:'TSE TOKYO',              region:'asia', fav:true,
      // JST UTC+9 â†’ 09:00â€“11:30 / 12:30â€“15:30 local
      // UTC: 00:00â€“02:30 / 03:30â€“06:30 â†’ Tahiti: 14:00â€“16:30 / 17:30â€“20:30 (prev day context: displayed as 00:00â€“02:30 / 03:30â€“06:30)
      both:[{open:'00:00',close:'02:30'},{open:'03:30',close:'06:30'}] },

    { id:'hkex',    name:'HKEX HONG KONG',         region:'asia', fav:true,
      // HKT UTC+8 â†’ 09:30â€“12:00 / 13:00â€“16:00 local
      // UTC: 01:30â€“04:00 / 05:00â€“08:00 â†’ Tahiti: 15:30â€“18:00 / 19:00â€“22:00
      both:[{open:'15:30',close:'18:00'},{open:'19:00',close:'22:00'}] },

    { id:'sse',     name:'SSE SHANGHAI',           region:'asia', fav:true,
      // CST UTC+8 â†’ 09:30â€“11:30 / 13:00â€“15:00 local
      // UTC: 01:30â€“03:30 / 05:00â€“07:00 â†’ Tahiti: 15:30â€“17:30 / 19:00â€“21:00
      both:[{open:'15:30',close:'17:30'},{open:'19:00',close:'21:00'}] },

    { id:'szse',    name:'SZSE SHENZHEN',          region:'asia', fav:false,
      both:[{open:'15:30',close:'17:30'},{open:'19:00',close:'21:00'}] },

    { id:'krx',     name:'KRX SÃ‰OUL',              region:'asia', fav:false,
      // KST UTC+9 â†’ 09:00â€“15:30 (no lunch break since 2000)
      // UTC: 00:00â€“06:30 â†’ Tahiti: 14:00â€“20:30
      both:[{open:'14:00',close:'20:30'}] },

    { id:'twse',    name:'TWSE TAIPEI',            region:'asia', fav:false,
      // CST UTC+8 â†’ 09:00â€“13:30 local â†’ UTC 01:00â€“05:30 â†’ Tahiti 15:00â€“19:30
      both:[{open:'15:00',close:'19:30'}] },

    { id:'bse',     name:'BSE/NSE MUMBAI',         region:'asia', fav:false,
      // IST UTC+5:30 â†’ 09:15â€“15:30 local
      // hiver UTC 03:45â€“10:00 â†’ Tahiti 17:45â€“00:00
      // Ã©tÃ©   UTC 03:45â€“10:00 â†’ Tahiti 17:45â€“00:00 (IST no DST)
      both:[{open:'17:45',close:'00:00'}] },

    { id:'sgx',     name:'SGX SINGAPOUR',          region:'asia', fav:false,
      // SGT UTC+8 â†’ 09:00â€“17:00 (equities) â†’ UTC 01:00â€“09:00 â†’ Tahiti 15:00â€“23:00
      both:[{open:'15:00',close:'23:00'}] },

    { id:'idx',     name:'IDX JAKARTA',            region:'asia', fav:false,
      // WIB UTC+7 â†’ 09:00â€“11:30 / 13:30â€“15:49 â†’ UTC 02:00â€“04:30 / 06:30â€“08:49 â†’ Tahiti 16:00â€“18:30 / 20:30â€“22:49
      both:[{open:'16:00',close:'18:30'},{open:'20:30',close:'22:49'}] },

    { id:'bursa',   name:'BURSA MALAYSIA',         region:'asia', fav:false,
      // MYT UTC+8 â†’ 09:00â€“12:30 / 14:30â€“17:00 â†’ UTC 01:00â€“04:30 / 06:30â€“09:00 â†’ Tahiti 15:00â€“18:30 / 20:30â€“23:00
      both:[{open:'15:00',close:'18:30'},{open:'20:30',close:'23:00'}] },

    { id:'set',     name:'SET BANGKOK',            region:'asia', fav:false,
      // ICT UTC+7 â†’ 10:00â€“12:30 / 14:30â€“17:00 â†’ UTC 03:00â€“05:30 / 07:30â€“10:00 â†’ Tahiti 17:00â€“19:30 / 21:30â€“00:00
      both:[{open:'17:00',close:'19:30'},{open:'21:30',close:'00:00'}] },

    // â”€â”€ MOYEN-ORIENT / AFRIQUE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'tadawul', name:'TADAWUL RIYAD',          region:'mideast', fav:true,
      // AST UTC+3 (no DST) â†’ 10:00â€“15:10 local â†’ UTC 07:00â€“12:10 â†’ Tahiti 21:00â€“02:10 (Sunâ€“Thu)
      both:[{open:'21:00',close:'02:10'}] },

    { id:'dfm',     name:'DFM DUBAI',              region:'mideast', fav:false,
      // GST UTC+4 â†’ 10:00â€“14:00 / 14:30â€“15:00 â†’ UTC 06:00â€“11:00 â†’ Tahiti 20:00â€“01:00
      both:[{open:'20:00',close:'01:00'}] },

    { id:'adx',     name:'ADX ABU DHABI',          region:'mideast', fav:false,
      both:[{open:'20:00',close:'01:00'}] },

    { id:'tase',    name:'TASE TEL AVIV',          region:'mideast', fav:false,
      // IST UTC+2 hiver / UTC+3 Ã©tÃ© â†’ 09:59â€“17:29 local
      // hiver: 07:59â€“15:29 UTC â†’ Tahiti 21:59â€“05:29
      hiver:[{open:'21:59',close:'05:29'}],
      ete:  [{open:'20:59',close:'04:29'}] },

    { id:'jse',     name:'JSE JOHANNESBURG',       region:'mideast', fav:true,
      // SAST UTC+2 (no DST) â†’ 09:00â€“17:00 local â†’ UTC 07:00â€“15:00 â†’ Tahiti 21:00â€“05:00
      both:[{open:'21:00',close:'05:00'}] },

    { id:'egx',     name:'EGX LE CAIRE',           region:'mideast', fav:false,
      // EET UTC+2 / EEST UTC+3 â†’ 10:00â€“14:30 local
      // hiver: 08:00â€“12:30 UTC â†’ Tahiti 22:00â€“02:30
      hiver:[{open:'22:00',close:'02:30'}],
      ete:  [{open:'21:00',close:'01:30'}] },
];

const OVERLAPS = [
    { label:'Asie â†’ Europe',  hiver:{open:'22:00',close:'01:00'}, ete:{open:'21:00',close:'00:00'}, color:'#9b59b6', desc:'Tokyo + PrÃ©-ouverture London' },
    { label:'Europe â†’ NY âš¡', hiver:{open:'04:30',close:'06:30'}, ete:{open:'03:30',close:'05:30'}, color:'#3498db', desc:'Session la plus volatile â€” max liquiditÃ© EUR/USD' },
    { label:'London Fix ğŸ¯',   hiver:{open:'02:00',close:'02:05'}, ete:{open:'01:00',close:'01:05'}, color:'#f0b90b', desc:'Fixing WM/Reuters â€” pic de volume FX' },
    { label:'NY Close + Asie', hiver:{open:'11:00',close:'14:00'}, ete:{open:'10:00',close:'14:00'}, color:'#02c076', desc:'ClÃ´ture NY + ouverture NZX/ASX' },
    { label:'Asie Mid-Session',hiver:{open:'15:30',close:'20:30'}, ete:{open:'15:30',close:'20:30'}, color:'#e67e22', desc:'Tokyo + HK + Shanghai actifs' },
];

const ALGOS = {
    hiver:[
        { time:"20:30", label:"Algos Europe Pre-mkt" },
        { time:"22:00", label:"Open Europe" },
        { time:"02:00", label:"London Fix" },
        { time:"04:30", label:"Open Wall Street" },
        { time:"09:00", label:"NY Options Re-fix" },
        { time:"11:00", label:"MOC Algos" }
    ],
    ete:[
        { time:"19:30", label:"Algos Europe Pre-mkt" },
        { time:"21:00", label:"Open Europe" },
        { time:"01:00", label:"London Fix" },
        { time:"03:30", label:"Open Wall Street" },
        { time:"08:00", label:"NY Options Re-fix" },
        { time:"10:00", label:"MOC Algos" }
    ]
};

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentSeason = localStorage.getItem('tahiti_season') || 'hiver';
let currentRegion = 'fav';

function setSeason(s) {
    currentSeason = s;
    localStorage.setItem('tahiti_season', s);
    document.getElementById('btn-hiver').classList.toggle('active', s === 'hiver');
    document.getElementById('btn-ete').classList.toggle('active',  s === 'ete');
    buildHeatmap();
    update();
}

function setRegion(r) {
    currentRegion = r;
    document.querySelectorAll('.region-tab').forEach(el => {
        const onclick = el.getAttribute('onclick') || '';
        el.classList.toggle('active', onclick.includes(`'${r}'`));
    });
    update();
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeToMin(t) {
    const [h, m] = t.split(':').map(Number);
    return h * 60 + (m || 0);
}
function isInSession(open, close, curMin) {
    const s = timeToMin(open), e = timeToMin(close);
    return s < e ? (curMin >= s && curMin < e) : (curMin >= s || curMin < e);
}
function getMktSessions(mkt) {
    return mkt.both || mkt[currentSeason];
}
function getMktStatus(mkt, curMin) {
    const sessions = getMktSessions(mkt);
    for (const sess of sessions) {
        if (isInSession(sess.open, sess.close, curMin)) return 'open';
    }
    // Check if in break (between sessions)
    if (sessions.length > 1) {
        const s1end = timeToMin(sessions[0].close);
        const s2start = timeToMin(sessions[1].open);
        if (isInSession(sessions[0].close, sessions[1].open, curMin)) return 'break';
    }
    return 'closed';
}
function getSessionProgress(sessions, curMin) {
    // For main display session, return overall day progress
    const first = sessions[0], last = sessions[sessions.length - 1];
    const dayStart = timeToMin(first.open), dayEnd = timeToMin(last.close);
    const totalDuration = dayEnd > dayStart ? dayEnd - dayStart : 1440 - dayStart + dayEnd;
    let elapsed = 0;
    if (dayEnd > dayStart) {
        if (curMin >= dayStart && curMin <= dayEnd) elapsed = curMin - dayStart;
    } else {
        if (curMin >= dayStart) elapsed = curMin - dayStart;
        else if (curMin < dayEnd) elapsed = (1440 - dayStart) + curMin;
    }
    return Math.min(100, Math.round(elapsed / totalDuration * 100));
}
function minutesUntilNext(sessions, curMin) {
    // Find next open
    let minDiff = Infinity;
    for (const sess of sessions) {
        const target = timeToMin(sess.open);
        let diff = target - curMin;
        if (diff <= 0) diff += 1440;
        if (diff < minDiff) minDiff = diff;
    }
    return minDiff;
}
function formatCountdown(min) {
    const h = Math.floor(min / 60), m = min % 60;
    return h > 0 ? `${h}h${String(m).padStart(2,'0')}` : `${m}min`;
}
function sessionsStr(sessions) {
    return sessions.map(s => `${s.open}â€“${s.close}`).join(' ğŸ± ');
}

// â”€â”€â”€ HEATMAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildHeatmap() {
    const slots = 48; // 30-min slots
    const HM_MKTS = ALL_MARKETS.filter(m => ['nq_es','lse','tse','hkex','sse','asx','nyse','bse','sgx','krx','tadawul','jse'].includes(m.id));

    // Count open markets per slot
    const counts = new Array(slots).fill(0);
    ALL_MARKETS.forEach(mkt => {
        const sessions = getMktSessions(mkt);
        for (let s = 0; s < slots; s++) {
            const mid = s * 30 + 15;
            for (const sess of sessions) {
                if (isInSession(sess.open, sess.close, mid)) { counts[s]++; break; }
            }
        }
    });

    // Break slots per heatmap market
    const breakSlots = {};
    HM_MKTS.forEach(mkt => {
        breakSlots[mkt.id] = new Array(slots).fill(false);
        const sessions = getMktSessions(mkt);
        if (sessions.length > 1) {
            for (let s = 0; s < slots; s++) {
                const mid = s * 30 + 15;
                if (isInSession(sessions[0].close, sessions[1].open, mid)) breakSlots[mkt.id][s] = true;
            }
        }
    });

    let html = '<thead><tr><th class="mkt-label"></th>';
    for (let h = 0; h < 24; h++) html += `<th colspan="2">${String(h).padStart(2,'0')}h</th>`;
    html += '</tr></thead><tbody>';

    // Liquidity row
    html += '<tr><td class="mkt-label" style="color:var(--yellow);font-weight:bold">LiquiditÃ©</td>';
    for (let s = 0; s < slots; s++) {
        const c = counts[s];
        const cls = c === 0 ? 'heat-0' : c <= 2 ? 'heat-1' : c <= 4 ? 'heat-2' : c <= 7 ? 'heat-3' : c <= 10 ? 'heat-4' : 'heat-5';
        html += `<td class="${cls}" data-slot="${s}" title="${c} marchÃ©s">${c || ''}</td>`;
    }
    html += '</tr>';

    HM_MKTS.forEach(mkt => {
        const sessions = getMktSessions(mkt);
        const dot = `<span class="region-dot" style="background:${REGION_COLORS[mkt.region]}"></span>`;
        html += `<tr><td class="mkt-label">${dot}${mkt.name.split(' ')[0]}</td>`;
        for (let s = 0; s < slots; s++) {
            const mid = s * 30 + 15;
            let isOpen = false;
            for (const sess of sessions) {
                if (isInSession(sess.open, sess.close, mid)) { isOpen = true; break; }
            }
            const isBreak = breakSlots[mkt.id][s];
            const cls = isOpen ? 'heat-open' : isBreak ? 'heat-break' : 'heat-0';
            html += `<td class="${cls}" data-slot="${s}"></td>`;
        }
        html += '</tr>';
    });

    html += '</tbody>';
    document.getElementById('heatmap').innerHTML = html;
    updateHeatmapNow();
}

function updateHeatmapNow() {
    const now = new Date();
    const curSlot = Math.floor((now.getHours() * 60 + now.getMinutes()) / 30);
    document.querySelectorAll('.heatmap-table td[data-slot]').forEach(td => {
        td.classList.toggle('hour-now', parseInt(td.dataset.slot) === curSlot);
    });
}

// â”€â”€â”€ MAIN UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function update() {
    const now = new Date();
    const curMin = now.getHours() * 60 + now.getMinutes();
    document.getElementById('clock').innerText = now.toLocaleTimeString('fr-FR');
    document.getElementById('date').innerText  = now.toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'short', year:'numeric'});
    // UTC display
    const utcH = String(now.getUTCHours()).padStart(2,'0');
    const utcM = String(now.getUTCMinutes()).padStart(2,'0');
    const utcS = String(now.getUTCSeconds()).padStart(2,'0');
    document.getElementById('utc-clock').innerText = `UTC ${utcH}:${utcM}:${utcS}`;

    // Filter markets
    let filtered;
    if (currentRegion === 'fav') filtered = ALL_MARKETS.filter(m => m.fav);
    else if (currentRegion === 'all') filtered = ALL_MARKETS;
    else filtered = ALL_MARKETS.filter(m => m.region === currentRegion);

    let html = '';
    filtered.forEach(mkt => {
        const sessions = getMktSessions(mkt);
        const status = getMktStatus(mkt, curMin);
        const pct = (status === 'open' || status === 'break') ? getSessionProgress(sessions, curMin) : 0;
        const color = REGION_COLORS[mkt.region];
        const dot = `<span class="region-dot" style="background:${color}"></span>`;
        const sessHtml = sessions.length > 1 ? sessions.map((s,i) => `${s.open}â€“${s.close}${i<sessions.length-1?'<span class="break-badge">ğŸ± pause</span>':''}`).join(' ') : `${sessions[0].open}â€“${sessions[0].close}`;

        let statusBadge, barClass, countdownHtml = '';
        if (status === 'open') {
            statusBadge = '<span class="status-badge open">â— OUVERT</span>';
            barClass = 'bar-open';
        } else if (status === 'break') {
            statusBadge = '<span class="status-badge on-break">ğŸ± PAUSE</span>';
            barClass = 'bar-break';
            // find next session
            const s2start = sessions[1] ? sessions[1].open : sessions[0].open;
            const diff = minutesUntilNext([sessions[1] || sessions[0]], curMin);
            countdownHtml = `<div class="countdown">reprise dans ${formatCountdown(diff)}</div>`;
        } else {
            statusBadge = '<span class="status-badge closed">FERMÃ‰</span>';
            barClass = 'bar-closed';
            const diff = minutesUntilNext(sessions, curMin);
            const cls = diff < 60 ? 'soon' : '';
            countdownHtml = `<div class="countdown ${cls}">ouverture dans ${formatCountdown(diff)}</div>`;
        }

        html += `<tr class="market-row">
            <td><div style="display:flex;align-items:center">${dot}<b>${mkt.name}</b></div></td>
            <td style="font-family:monospace;font-size:0.8rem;color:var(--yellow)">${sessHtml}</td>
            <td style="min-width:80px">
                <div class="progress-wrap"><div class="progress-bar ${barClass}" style="width:${pct}%"></div></div>
                <div style="font-size:0.6rem;color:var(--gray);margin-top:2px">${pct > 0 ? pct+'%' : 'â€”'}</div>
            </td>
            <td style="text-align:right">${statusBadge}${countdownHtml}</td>
        </tr>`;
    });
    document.getElementById('market-list').innerHTML = html;

    // OVERLAP CARDS
    let ocHtml = '';
    OVERLAPS.forEach(ov => {
        const t = ov.both ? ov.both : (currentSeason === 'hiver' ? ov.hiver : ov.ete);
        const live = isInSession(t.open, t.close, curMin);
        ocHtml += `<div class="overlap-card ${live?'live':''}">
            <div class="overlap-title" style="color:${ov.color}">${live ? 'ğŸ”´ ' : ''}${ov.label}</div>
            <div class="overlap-time">${t.open} â€“ ${t.close}</div>
            <div class="overlap-desc">${ov.desc}</div>
        </div>`;
    });
    document.getElementById('overlap-cards').innerHTML = ocHtml;

    // ALGOS
    // Find next algo
    const algos = ALGOS[currentSeason];
    let nextIdx = -1, minDiff = Infinity;
    algos.forEach((a, i) => {
        const aMin = timeToMin(a.time);
        let diff = aMin - curMin; if (diff <= 0) diff += 1440;
        if (diff < minDiff) { minDiff = diff; nextIdx = i; }
    });

    let algoHtml = '';
    algos.forEach((a, i) => {
        const aMin = timeToMin(a.time);
        const isActive = curMin >= aMin && curMin < (aMin + 15);
        const isNext = !isActive && i === nextIdx;
        algoHtml += `<div class="algo-card ${isActive ? 'algo-active' : isNext ? 'algo-next' : ''}">
            <div class="algo-time">${a.time} ${isActive ? 'âš¡' : isNext ? 'â†’' : ''}</div>
            <div class="algo-title">${a.label}</div>
            ${isNext ? `<div style="font-size:0.65rem;color:var(--gray);margin-top:3px">dans ${formatCountdown(minDiff)}</div>` : ''}
        </div>`;
    });
    document.getElementById('algo-list').innerHTML = algoHtml;

    updateHeatmapNow();
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setSeason(currentSeason);
setRegion(currentRegion);
buildHeatmap();
setInterval(update, 1000);
</script>
</body>
</html>
